<div class="topbar">
  <div class="brand">
    <a routerLink="/">
      <img src="assets/images/logo_oficial.png" alt="Logo" class="logo">
    </a>
  </div>



  <div class="toggle-button-cover">
        <div id="button-3" class="button r">
         
          <input 
        type="checkbox" 
        [(ngModel)]="autoUpdateYears"
        class="checkbox">
        
          <div class="knobs"></div>
          <div class="layer"></div>
        </div>
      </div>





  <div class="top-actions">
  <button class="btn-azul" (click)="abrirModalGuardarProyecto()" title="Guardar Proyecto">
    <span>Guardar</span>
  </button>

  <div class="exportar-wrapper">
    <button class="btn-verde" (click)="toggleExportMenu()" title="Exportar">
      <span>Exportar</span>
     <i class="fa-solid fa-arrow-up-right-from-square"></i>
    </button>

    <!-- Men√∫ flotante -->
    <div class="export-menu" *ngIf="mostrarMenuExportar">
      <button (click)="exportAsImage()" class="export-option">
        <i class="fa-solid fa-download"></i>
        <span>Descargar</span>
      </button>

      <button (click)="compartirProyecto()" class="export-option">
        <i class="fa-solid fa-link"></i>
        <span>Compartir</span>
      </button>
    </div>
  </div>
</div>
</div>

<div class="workspace">
  <aside class="sidebar">
<div class="section">
      <h4>Nuevo Evento</h4>
      <button class="btn-accent full" (click)="openEventModal()">+ A√±adir Evento</button>
    </div>
<h4>Cambiar de Plantilla</h4>
    <div class="section">
      <button class="btn-primary full" (click)="abrirSelectorPlantillasDiseno()">
        <i class="fa-solid fa-palette"></i> Cambiar Plantilla
      </button>
    </div>

    

    <div class="section">
      <h4>üé® Fondo</h4>
      <div class="color-palette">
        <div *ngFor="let color of backgroundColors"
             class="color-option"
             [style.background]="color"
             [class.active]="backgroundColor === color"
             (click)="changeBackgroundColor(color)">
        </div>
      </div>
    </div>

    <div class="section">
      
      <button class="btn-outline full" routerLink="/usuario/mis-proyectos">
        <i class="fa-solid fa-folder-open"></i> Ver mis Proyectos
      </button>
    </div>

    <div class="section">
      <h4>Estilos de Texto</h4>
      <div class="style-group">
        <label>T√≠tulo</label>
        <select (change)="cambiarEstiloTexto('titulo', 'color', $any($event.target).value)">
          <option value="">Color...</option>
          <option value="#222">Negro</option>
          <option value="#3b82f6">Azul</option>
          <option value="#ef4444">Rojo</option>
          <option value="#10b981">Verde</option>
        </select>
      </div>
      <div class="style-group">
        <label>Descripci√≥n</label>
        <select (change)="cambiarEstiloTexto('descripcion', 'tama√±o', $any($event.target).value)">
          <option value="">Tama√±o...</option>
          <option value="12">Peque√±o</option>
          <option value="16">Mediano</option>
          <option value="20">Grande</option>
        </select>
      </div>
    </div>
  </aside>

  <main class="canvas-area">
  
  <div #container id="konva-container" [style.transform]="'scale(' + (containerSize/100) + ')'"></div>
  
</main>
</div>

<div class="canvas-controls">
  <label for="container-size"></label>
  <input 
    type="range" 
    id="container-size"
    min="50" 
    max="150" 
    step="10" 
    value="100"
    [(ngModel)]="containerSize"
    (input)="onContainerSizeChange()"
    class="size-slider">
  <span class="size-value">{{containerSize}}%</span>
  
  <div class="presentacion">
   
      <button (click)="togglePresentacion()" class="presentacion-btn" [class.active]="isPresentacionMode" title="Modo Presentaci√≥n">
      <i class="bi bi-tv"></i>
      <span>{{ isPresentacionMode ? 'Salir' : 'Presentaci√≥n' }}</span>
    </button>
  </div>
</div>









<!-- Modal para Editar Evento -->
<div *ngIf="showEditModal" class="modal-overlay">
  <div class="modal-content">
    <h3>Editar Evento</h3>
    
    <div class="form-group">
      <label>A√±o:</label>
      <input type="number" [(ngModel)]="editedEvent.year" min="1800" max="2000">
    </div>

    <div class="form-group">
      <label>T√≠tulo:</label>
      <input type="text" [(ngModel)]="editedEvent.title" placeholder="T√≠tulo del evento">
    </div>

    <div class="form-group">
      <label>Personaje:</label>
      <input type="text" [(ngModel)]="editedEvent.person" placeholder="Personaje involucrado">
    </div>

    <div class="form-group">
      <label>Descripci√≥n:</label>
      <textarea [(ngModel)]="editedEvent.description" placeholder="Descripci√≥n del evento" rows="3"></textarea>
    </div>

    <div class="form-group">
      <label>Enlace:</label>
      <input type="url" [(ngModel)]="editedEvent.link" placeholder="https://ejemplo.com">
      <small class="help-text">URL opcional para m√°s informaci√≥n</small>
    </div>

    <div class="form-group">
      <label>Imagen:</label>
      <input type="file" (change)="onEditImageSelected($event)" accept="image/*">
      <div *ngIf="editedEvent.image" class="image-preview">
        <img [src]="editedEvent.image" alt="Vista previa" style="max-width: 100px; max-height: 100px;">
        <button type="button" (click)="removeImage()" class="btn-remove">Eliminar imagen</button>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" (click)="deleteEvent()" class="btn-delete">Eliminar Evento</button>
      <div>
        <button type="button" (click)="closeEditModal()" class="btn-cancel">Cancelar</button>
        <button type="button" (click)="updateEvent()" class="btn-save">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para a√±adir evento -->
<div class="modal" [class.active]="showEventModal">
  <div class="modal-content">
    <h3>A√±adir Nuevo Evento</h3>
    
    <div class="form-group">
      <label for="event-year">Fecha:</label>
      <input 
        type="number" 
        id="event-year" 
        [(ngModel)]="newEvent.year" 
        placeholder="Ej: 1917"
        min="1800"
        max="2000">
    </div>
    
    <div class="form-group">
      <label for="event-title">T√≠tulo de Evento:</label>
      <input 
        type="text" 
        id="event-title" 
        [(ngModel)]="newEvent.title" 
        placeholder="T√≠tulo del evento">
    </div>
    
    <div class="form-group">
      <label for="event-person">Personaje:</label>
      <input 
        type="text" 
        id="event-person" 
        [(ngModel)]="newEvent.person" 
        placeholder="Ej: Cesar Vallejo">
    </div>
    
    <div class="form-group">
      <label for="event-description">Descripci√≥n:</label>
      <textarea 
        id="event-description" 
        [(ngModel)]="newEvent.description" 
        placeholder="Descripci√≥n del evento"
        rows="3"></textarea>
    </div>
    <div class="form-group">
      <label for="event-link">Enlace:</label>
      <input 
        type="url" 
        id="event-link" 
        [(ngModel)]="newEvent.link" 
        placeholder="https://ejemplo.com (opcional)">
    </div>
    
    <div class="form-group">
      <label for="event-image">Imagen:</label>
      <input 
        type="file" 
        id="event-image" 
        (change)="onImageSelected($event)" 
        accept="image/*">
    </div>
    
    <div class="modal-buttons">
      <button (click)="closeEventModal()" class="modal-btn cancel">Cancelar</button>
      <button (click)="addEventToTimeline()" class="modal-btn add">A√±adir a la l√≠nea de Tiempo</button>
    </div>
  </div>
</div>


<!-- Selector de plantillas -->
<!--<div *ngIf="showTemplateSelector" class="modal-overlay">
  <div class="modal-content">
    <h3>Seleccionar Plantilla</h3>
    <div class="templates-list">
      <div *ngFor="let template of availableTemplates" 
           class="template-option"
           (click)="applyTemplate(template)">
        <div class="template-preview" 
             [style.background]="template.styles.backgroundColor"></div>
        <span>{{template.name}}</span>
      </div>
    </div>
    <button (click)="showTemplateSelector = false" class="btn btn-secondary">
      Cancelar
    </button>
  </div>
</div>-->




<!-- En editor.component.html -->
<!-- Modal para seleccionar plantillas de dise√±o -->
<div *ngIf="showDesignTemplatesModal" class="modal-overlay">
  <div class="modal-content">
    <h3>üé® Seleccionar Dise√±o de Plantilla</h3>
    
    <div class="design-templates-grid">
      <div *ngFor="let plantilla of plantillasDisponibles" 
           class="design-template-card"
           (click)="aplicarPlantillaDiseno(plantilla)">
        
        <div class="template-preview" 
             [style.background]="plantilla.configuracion.backgroundColor">
          <div class="preview-elements">
            <!-- Mini preview de los elementos -->
            <div *ngFor="let elemento of plantilla.configuracion.elementos.slice(0, 3)"
                 class="preview-element"
                 [class]="'preview-' + elemento.tipo.toLowerCase()">
            </div>
          </div>
        </div>
        
        <div class="template-info">
          <h4>{{plantilla.nombre}}</h4>
          <p>{{plantilla.descripcion}}</p>
          <div class="template-meta">
            <span>üìê {{plantilla.configuracion.elementos.length}} elementos</span>
            <span>üìÖ {{plantilla.fechaCreacion | date:'shortDate'}}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="showDesignTemplatesModal = false">
        Cancelar
      </button>
    </div>
  </div>
</div>




<!-- MODAL PARA GUARDAR PROYECTO -->
<div *ngIf="showSaveProjectModal" class="modal-overlay">
  <div class="modal-content">
    <h3>üíæ Guardar Proyecto</h3>
    
    <div *ngIf="!proyectoGuardado" class="form-container">
      <div class="form-group">
        <label for="project-name">Nombre del Proyecto:</label>
        <input 
          type="text" 
          id="project-name" 
          [(ngModel)]="proyectoNombre" 
          placeholder="Ingresa un nombre para tu proyecto"
          class="form-input">
      </div>

      <div class="form-group">
        <label for="project-description">Descripci√≥n:</label>
        <textarea 
          id="project-description" 
          [(ngModel)]="proyectoDescripcion" 
          placeholder="Describe tu proyecto (opcional)"
          rows="3"
          class="form-textarea"></textarea>
      </div>

      <div class="project-summary">
        <h4>Resumen del Proyecto:</h4>
        <div class="summary-items">
          <div class="summary-item">
            <span class="summary-label">Eventos:</span>
            <span class="summary-value">{{timelineEvents.length}}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Elementos:</span>
            <span class="summary-value">{{serializarElementosKonva().length}}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Rango de a√±os:</span>
            <span class="summary-value">{{minYear}} - {{maxYear}}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Portada:</span>
            <span class="summary-value">Autom√°tica</span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button 
          type="button" 
          (click)="cerrarModalGuardarProyecto()" 
          class="btn btn-secondary">
          Cancelar
        </button>
        <button 
          type="button" 
          (click)="guardarProyecto()" 
          class="btn btn-primary"
          [disabled]="!proyectoNombre.trim()">
          {{proyectoActualId ? 'Actualizar' : 'Guardar'}} Proyecto
        </button>
      </div>
    </div>

    <!-- Mensaje de √©xito -->
    <div *ngIf="proyectoGuardado" class="success-message">
      <div class="success-icon">‚úÖ</div>
      <h4>¬°Proyecto Guardado Exitosamente!</h4>
      <p>Tu proyecto "{{proyectoNombre}}" ha sido guardado correctamente.</p>
      <button 
        type="button" 
        (click)="cerrarModalGuardarProyecto()" 
        class="btn btn-primary">
        Continuar Editando
      </button>
    </div>
  </div>
</div>









